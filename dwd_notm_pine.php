<?phprequire 'vendor/autoload.php'; // path to PhpSpreadsheet autoloaduse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;include 'includes/database.php';$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');	$all_data = [];  // final combined array// ---------- SBI query ----------$u_query_sbi = "SELECT 					a.*, 					b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode, 					b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status, 					b.rrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month, 					b.card_type_trns,					c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amt				FROM happi_sbi_transactions a				JOIN (					SELECT * FROM happi_all_transactions					WHERE id IN (						SELECT MIN(id)						FROM happi_all_transactions						WHERE acquirer = 'SBI87' AND datetime = '$get_date'						GROUP BY approval_code					)				) b ON b.approval_code = a.auth_code AND a.tran_date = b.datetime				JOIN (					SELECT * FROM happi_apx_transactions					WHERE id IN (						SELECT MIN(id)						FROM happi_apx_transactions  WHERE trn_date = '$get_date'						GROUP BY apr_no					)				) c ON (c.apr_no = a.auth_code)				WHERE a.tran_date = '$get_date'				ORDER BY a.id ASC";$u_res_sbi = mysqli_query($conn, $u_query_sbi);while ($row = mysqli_fetch_assoc($u_res_sbi)) {    $row['source'] = 'SBI';    $all_data[] = $row;}// ---------- HDFC query ----------$u_query_hdfc = "SELECT 					a.*, 					b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode, b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status, b.rrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month, b.card_type_trns, c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amt				FROM happi_hdfc_transactions a				JOIN (					SELECT * FROM happi_all_transactions					WHERE id IN (						SELECT MIN(id)						FROM happi_all_transactions						WHERE acquirer = 'HDFC'						GROUP BY approval_code,datetime					)				) b ON (b.approval_code = a.approve_code AND a.trans_date = b.datetime)				JOIN (					SELECT * FROM happi_apx_transactions					WHERE id IN (						SELECT MIN(id)						FROM happi_apx_transactions						GROUP BY apr_no,trn_date					)				) c ON (c.apr_no = a.approve_code AND a.trans_date = c.trn_date)				WHERE a.trans_date = '$get_date'				ORDER BY a.id ASC";$u_res_hdfc = mysqli_query($conn, $u_query_hdfc);while ($row = mysqli_fetch_assoc($u_res_hdfc)) {    $row['source'] = 'HDFC';    $all_data[] = $row;}// ---------- PHONEPE query ----------$u_query_phonepe = "SELECT a.*,b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode, 					b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status, 					b.rrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month, 					b.card_type_trns, c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amt, u.host_txn_id, u.transaction_id, u.bill_reference_no				FROM happi_phonepe_transactions a 				JOIN happi_upi_transactions u ON(u.host_txn_id = a.phonepe_referenceId AND u.txn_date = a.transaction_date) 				JOIN happi_apx_transactions c ON(c.card_no = u.bill_reference_no AND c.trn_date = a.transaction_date) 				JOIN happi_all_transactions b ON(u.transaction_id = b.transaction_id AND a.transaction_date = b.datetime) 				where a.transaction_date = '$get_date' ORDER BY a.id ASC";$u_res_phonepe = mysqli_query($conn, $u_query_phonepe);while ($row = mysqli_fetch_assoc($u_res_phonepe)) {    $row['source'] = 'PHONEPE';    $all_data[] = $row;}// ---------- OTHER (not PHONEPE, HDFC, SBI) query ----------$u_query_other = "SELECT 				a.*, 				b.voucher_no, 				b.apr_no, 				b.invoice_no, 				b.trn_date, 				b.amount AS apx_amt 			FROM 				happi_all_transactions a 			JOIN 				happi_apx_transactions b ON (a.transaction_id = b.apr_no AND b.trn_date = a.datetime)			WHERE 				a.datetime = '$get_date' AND a.acquirer NOT IN ('PHONEPE','HDFC','SBI87')";$u_res_other = mysqli_query($conn, $u_query_other);while ($row = mysqli_fetch_assoc($u_res_other)) {    $row['source'] = 'OTHER';    $all_data[] = $row;}// ---------- Final result ----------$u_mathed_count = count($all_data);if($u_mathed_count != 0){		$auth_code_no = [];  // Array to hold trn_date values   	foreach ($all_data as $matcheddata) {		$auth_code_no[] = $matcheddata['transaction_id'];	}    // Implode into a comma-separated string    $auth_code_no_str = "'" . implode("','", $auth_code_no) . "'";}/* 	$u_query = "SELECT a.*,b1.voucher_no, 				b1.apr_no, 				b1.invoice_no, 				b1.trn_date, 				b1.amount AS apx_amt FROM happi_all_transactions a LEFT JOIN happi_apx_transactions b1 ON TRIM(a.approval_code) = TRIM(b1.apr_no) LEFT JOIN happi_apx_transactions b2 ON TRIM(a.transaction_id) = TRIM(b2.apr_no) WHERE a.datetime = '$get_date' AND b1.apr_no IS NULL AND b2.apr_no IS NULL ORDER BY a.id ASC"; */	$u_query = "SELECT * FROM happi_all_transactions WHERE datetime = '$get_date' AND transaction_id NOT IN ($auth_code_no_str) ORDER BY id ASC";		//echo $u_query;exit;								//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res); //echo $u_count;exit;$u_res_data = [];while ($u_res_res = mysqli_fetch_assoc($u_res)) {    $u_res_data[] = $u_res_res;}// Create spreadsheet$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Headers$fields = array(    'POS ID', 'TID', 'NAME AND LOC', 'Acquirer','TXN ID', 'RRN', 'Approval Code',    'Txn Amount', 'TXN Date', 'Apx Approval', 'Apx Invoice', 'Apx amt',    'Apx Date', 'Card Network', 'Card Colour');$sheet->fromArray($fields, NULL, 'A1');// Fill rows$rowIndex = 2;foreach ($u_res_data as $row) {   /*  $apx_amt = $row['apx_amt'];    $txn_amount = $row['net_amount'];    $diffamt = $apx_amt - $txn_amount;    if ($diffamt == '') $diffamt = 0;    $perc = ($apx_amt != 0) ? ($diffamt / $apx_amt) * 100 : 0;    $mdrper = '0.89';    if ($apx_amt > 2000) {        $TXN_Rate = 'ABOVE 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.89';    } else {        $TXN_Rate = 'BELOW 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.40';    }    $abc1 = round((($row['txn_amount'] - $row['net_amount']) / $row['txn_amount']) * 100 , 2);    $debutedmdr = $row['txn_amount'] - $row['net_amount'];    $abc2 = round(($debutedmdr / $row['txn_amount']) * 100 , 2);    $actual_mdr = round(($mdrper / 100) * $row['txn_amount'], 2); */		$datetime = $row['datetime'];		$datetime1 = explode('-',$row['datetime']);		$datetime = $datetime1[2].'-'.$datetime1[1].'-'.$datetime1[0];				/* $trn_date = $row['trn_date'];		if($trn_date != ''){			$trn_date1 = explode('-',$row['trn_date']);			$trn_date = $trn_date1[2].'-'.$trn_date1[1].'-'.$trn_date1[0];		} */    // Only populate lineData and write to sheet if apx_amt is not empty   // if($apx_amt != '') {        $lineData = array(            $row['pos'], $row['tid'], $row['store_name'], $row['acquirer'],             "'" .$row['transaction_id'], "'" . $row['rrn'], $row['approval_code'], $row['amount'],            $datetime, '--', '--', '--',            '--', $row['card_network'], $row['card_colour']        );        $sheet->fromArray($lineData, NULL, 'A' . $rowIndex);        // Highlight red if MDR Charges > 100        /* if ($abc2 > $mdrper) {				$sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([					'fill' => [						'fillType' => Fill::FILL_SOLID,						'startColor' => ['rgb' => 'FF9999']					]				]);			} */        $rowIndex++;    //}}// Set filename$filename = 'PINE-NOT-MATCHED-BULK-' . $get_date . '.xlsx';// Send headersheader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment; filename=\"$filename\"");header('Cache-Control: max-age=0');// Output Excel$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;?>