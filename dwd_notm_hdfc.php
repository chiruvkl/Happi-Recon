<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$u_mathed_query = "SELECT 					a.*, 					b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode, b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status, b.rrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month, b.card_type_trns, c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amt				FROM happi_hdfc_transactions a				JOIN (					SELECT * FROM happi_all_transactions					WHERE id IN (						SELECT MIN(id)						FROM happi_all_transactions						WHERE acquirer = 'HDFC'						GROUP BY approval_code,datetime					)				) b ON b.approval_code = a.approve_code AND a.trans_date = b.datetime				JOIN (					SELECT * FROM happi_apx_transactions					WHERE id IN (						SELECT MIN(id)						FROM happi_apx_transactions						GROUP BY apr_no,trn_date					)				) c ON (c.apr_no = a.approve_code AND a.trans_date = c.trn_date)				WHERE a.trans_date = '$get_date'				ORDER BY a.id ASC";	//echo $u_query;exit;$u_mathed_res = mysqli_query($conn, $u_mathed_query);$u_mathed_count = mysqli_num_rows($u_mathed_res);$auth_code_no = [];  // Array to hold trn_date valuesif($u_mathed_count != 0){		   	while ($u_mathed_res_res = mysqli_fetch_assoc($u_mathed_res)) {		$auth_code_no[] = $u_mathed_res_res['approve_code'];	}    // Implode into a comma-separated string    $auth_code_no_str = "'" . implode("','", $auth_code_no) . "'";}$u_query = "SELECT     a.*,b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode, 					b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status, 					b.rrn AS allrrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month, 					b.card_type_trnsFROM     happi_hdfc_transactions a JOIN happi_all_transactions b ON (b.acquirer = 'HDFC' AND b.datetime = '$get_date' AND b.approval_code = a.approve_code)WHERE     a.trans_date = '$get_date' AND a.approve_code NOT IN ($auth_code_no_str) AND b.approval_code NOT IN ($auth_code_no_str)ORDER BY     a.id ASC";$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'POS NO', 'TID Number', 'Store Name', 'CARD TYPE', 'TRANS DATE', 'SETTLE DATE',    'TXN Id', 'RRN No', 'APPROV CODE', 'DOMESTIC AMT', 'Net amount', 'APX approval',    'Apx Invoice', 'Apx amt', 'Apx date', 'Diff', 'MDR Charges', 'MDR%',    'Receipt No', 'enty type', 'TXN Rate', 'Debuted MDR', 'Debited MDR%',    'Actual Charges', 'Actuall MDR Amt', 'Diff %', 'Card Network', 'Card Colour');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    while ($row = mysqli_fetch_assoc($u_res)) {        $approval_code = $row['approval_code'];        $apx_amt = 0;        $txn_amount = $row['net_amount'];        $diffamt = $apx_amt - $txn_amount;        $mdrper = '1.53';        if ($apx_amt > 2000) {            $TXN_Rate = 'ABOVE 2K';            $mdrper = ($row['card_type_trns'] == 'CREDIT') ? '1.53' : '1.06';        } else {            $TXN_Rate = 'BELOW 2K';            $mdrper = ($row['card_type_trns'] == 'CREDIT') ? '1.53' : '0.40';        }		$domestic_amt = $row['domestic_amt'] + $row['intl_amt'];        $abc1 = round((($domestic_amt - $row['net_amount']) / $domestic_amt) * 100, 2);        $debutedmdr = $domestic_amt - $row['net_amount'];        $abc2 = round(($debutedmdr / $domestic_amt) * 100, 2);        $actual_mdr = round(($mdrper / 100) * $domestic_amt, 2);						$trans_date = $row['trans_date'];		$trans_date1 = explode('-',$row['trans_date']);		$trans_date = $trans_date1[2].'-'.$trans_date1[1].'-'.$trans_date1[0];		$settle_date = $row['settle_date'];		$settle_date1 = explode('-',$row['settle_date']);		$settle_date = $settle_date1[2].'-'.$settle_date1[1].'-'.$settle_date1[0];		/* $trn_date = $row['trn_date'];		$trn_date1 = explode('-',$row['trn_date']);		$trn_date = $trn_date1[2].'-'.$trn_date1[1].'-'.$trn_date1[0]; */			//if($apx_amt != '') {			$lineData = array(				$row['pos'], $row['tid'], $row['store_name'], $row['card_type_trns'], $trans_date, $settle_date,				"'" .$row['transaction_id'], "'" . $row['rrn'], $row['approve_code'], $domestic_amt, $row['net_amount'],				'--', '--', '--', '--',				($apx_amt - $domestic_amt),				($domestic_amt - $row['net_amount']), $abc1 . '%', '',				'PINE LABS-POS', $TXN_Rate, round($debutedmdr, 2), $abc2 . '%',				$mdrper . '%', $actual_mdr, ($actual_mdr - $debutedmdr),				$row['card_network'], $row['card_colour']			);			$sheet->fromArray($lineData, NULL, 'A' . $rowIndex);			// Highlight red if Debuted MDR > 100		   if ($abc2 > $mdrper) {				$sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([					'fill' => [						'fillType' => Fill::FILL_SOLID,						'startColor' => ['rgb' => 'FF9999']					]				]);			}			$rowIndex++;		//}    }}// Output as Excel$filename = 'HDFC-NOT-MATCHED-BULK-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;