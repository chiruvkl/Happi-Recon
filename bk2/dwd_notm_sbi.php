<?phprequire 'vendor/autoload.php'; // path to PhpSpreadsheet autoloaduse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;include 'includes/database.php';$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$u_query = "SELECT     a.*,     b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode,     b.transaction_id, b.approval_code, b.amount, b.datetime,     b.txn_status, b.rrn as allrrn, b.card_network, b.card_colour,     b.emi_txn, b.emi_month, b.card_type_trns,     c.voucher_no, c.apr_no, c.invoice_no, c.trn_date,     c.amount AS apx_amt FROM     happi_sbi_transactions a LEFT JOIN     happi_all_transactions b     ON b.approval_code = a.auth_code AND b.acquirer = 'SBI87' LEFT JOIN     happi_apx_transactions c     ON c.apr_no = a.auth_code WHERE     a.tran_date = '$get_date' AND c.apr_no IS NULLORDER BY     a.id ASC";$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$u_res_data = [];while ($u_res_res = mysqli_fetch_assoc($u_res)) {    $u_res_data[] = $u_res_res;}// Create spreadsheet$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Headers$fields = array(    'POS ID', 'TID', 'NAME AND LOC', 'Tran Date', 'Stl Date', 'TXN ID', 'RRN', 'Auth Code',    'Txn Amount', 'Net Amount', 'CardType1', 'Apx Approval', 'Apx Invoice', 'Apx amt',    'Apx Date', 'Diff amt', 'MDR Charges', 'MDR%', 'Receipt No', 'dsdsd',    'TXN Rate', 'Deducted MDR', 'Debited MDR%', 'Actual Charges',    'Actuall MDR Amt', 'Diff %', 'Card Network', 'Card Colour');$sheet->fromArray($fields, NULL, 'A1');// Fill rows$rowIndex = 2;foreach ($u_res_data as $row) {    $apx_amt = $row['apx_amt'];    $txn_amount = $row['net_amount'];    $diffamt = $apx_amt - $txn_amount;	if($diffamt == '')		$diffamt = 0;    $perc = ($apx_amt != 0) ? ($diffamt / $apx_amt) * 100 : 0;    $mdrper = '0.89';    if ($apx_amt > 2000) {        $TXN_Rate = 'ABOVE 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.89';    } else {        $TXN_Rate = 'BELOW 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.40';    }		$apx_amt2 = $row['apx_amt']; 	$txn_amount2 = $row['txn_amount']; 	$diffamt2 = $apx_amt2 - $txn_amount2;	if($diffamt2 == ''){		$diffamt2 = '0';	}	    $abc1 = round((($row['txn_amount'] - $row['net_amount']) / $row['txn_amount']) * 100 , 2);    $debutedmdr = $row['txn_amount'] - $row['net_amount'];    $abc2 = round(($debutedmdr / $row['txn_amount']) * 100 , 2);    $actual_mdr = round(($mdrper / 100) * $row['txn_amount'], 2);			$tran_date = $row['tran_date'];	$tran_date1 = explode('-',$row['tran_date']);	$tran_date = $tran_date1[2].'-'.$tran_date1[1].'-'.$tran_date1[0];		$trn_date = $row['trn_date'];	$trn_date1 = explode('-',$row['trn_date']);	$trn_date = $trn_date1[2].'-'.$trn_date1[1].'-'.$trn_date1[0];				$lineData = array(			$row['pos'], $row['tid'], $row['name_loc'], $tran_date, $row['stl_date'],			"'" .$row['transaction_id'], "'" . $row['rrn'], $row['auth_code'], $row['txn_amount'],			$row['net_amount'], $row['card_type'], $row['apr_no'], $row['invoice_no'], $row['apx_amt'],			$trn_date, $diffamt2, $debutedmdr, $abc1 . '%', '', 'PINE LABS-POS', $TXN_Rate,			round($debutedmdr, 2), $abc2 . '%', $mdrper . '%', $actual_mdr,			($actual_mdr - $debutedmdr), $row['card_network'], $row['card_colour']		);	    $sheet->fromArray($lineData, NULL, 'A' . $rowIndex);    // Highlight red if MDR Charges > 100    if ($abc2 > $mdrper) {        $sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([            'fill' => [                'fillType' => Fill::FILL_SOLID,                'startColor' => ['rgb' => 'FF9999']            ]        ]);    }    $rowIndex++;}// Set filename$filename = 'SBI-BULK-NOT-MATCHED-' . $get_date . '.xlsx';// Send headersheader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment; filename=\"$filename\"");header('Cache-Control: max-age=0');// Output Excel$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;?>