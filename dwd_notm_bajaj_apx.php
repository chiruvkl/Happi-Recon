<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$bajaj_ta_total_query = "SELECT upload_date FROM happi_bajaj_ta_transactions WHERE trans_date = '$get_date' GROUP BY upload_date"; $bajaj_ta_total_res = mysqli_query($conn, $bajaj_ta_total_query);$bajaj_ta_total_assoc = mysqli_fetch_assoc($bajaj_ta_total_res);$bajaj_upload_date = $bajaj_ta_total_assoc['upload_date'];/* $apx_total_query = "SELECT apr_no FROM happi_bajaj_apx_transactions where upload_date = '$bajaj_upload_date' group by apr_no";  $apx_total_res = mysqli_query($conn, $apx_total_query);$apx_total_cnt1 = mysqli_num_rows($apx_total_res); if($apx_total_cnt1 != 0){		$upload_apr_no = [];  // Array to hold trn_date values    while ($row = mysqli_fetch_assoc($apx_total_res)) {        $upload_apr_no[] = $row['apr_no'];    }    // Implode into a comma-separated string    $upload_apr_no_str = "'" . implode("','", $upload_apr_no) . "'";} */$u_query1 = "SELECT  c.*				FROM happi_bajaj_ta_transactions a 				JOIN happi_bajaj_do_transactions b ON(b.app_cas_id = a.txn_id) 				JOIN happi_bajaj_apx_transactions c ON(c.apr_no = b.do_id AND c.upload_date = a.upload_date ) 				LEFT JOIN happi_dbd_master_data d ON(d.invoice_no = c.invoice_no) 				where a.trans_date = '$get_date' AND a.upload_date = '$bajaj_upload_date'				ORDER BY c.id ASC"; //echo $u_query1;exit;	//echo $u_query;exit;$u_res1 = mysqli_query($conn, $u_query1);$u_count1 = mysqli_num_rows($u_res1);$matched_data = [];while ($row = mysqli_fetch_assoc($u_res1)) {    $matched_data[] = $row;}$apr_no_idNos = [];$apr_no_cardNos = [];$apr_no_invoice_nos = [];$apx_bajaj_total_query = "SELECT a.apr_no,a.card_no,a.invoice_no FROM happi_bajaj_apx_transactions a JOIN happi_bajaj_do_transactions b ON(b.do_id = a.apr_no) JOIN happi_bajaj_ta_transactions c ON(b.app_cas_id = c.txn_id AND c.upload_date = a.upload_date) LEFT JOIN happi_dbd_master_data d ON(d.invoice_no = a.invoice_no) where a.upload_date = '$bajaj_upload_date' AND c.trans_date < '$get_date' ORDER BY a.id ASC "; $apx_bajaj_total_res = mysqli_query($conn, $apx_bajaj_total_query); //echo $apx_bajaj_total_query;$apx_bajaj_total_cnt1 = mysqli_num_rows($apx_bajaj_total_res); $upload_bajaj_apr_no_str = '';if($apx_bajaj_total_cnt1 != 0){		$upload_bajaj_apr_no = [];  // Array to hold trn_date values    while ($bajaj_row = mysqli_fetch_assoc($apx_bajaj_total_res)) {		if (!empty($bajaj_row['apr_no'])) {			$apr_no_idNos[] = "'" . mysqli_real_escape_string($conn, $bajaj_row['apr_no']) . "'";		}		if (!empty($bajaj_row['card_no'])) {			$apr_no_cardNos[] = "'" . mysqli_real_escape_string($conn, $bajaj_row['card_no']) . "'";		}		if (!empty($bajaj_row['invoice_no'])) {			$apr_no_invoice_nos[] = "'" . mysqli_real_escape_string($conn, $bajaj_row['invoice_no']) . "'";		}    }}foreach ($matched_data as $row) {    if (!empty($row['apr_no'])) {        $apr_no_idNos[] = "'" . mysqli_real_escape_string($conn, $row['apr_no']) . "'";    }	if (!empty($row['card_no'])) {        $apr_no_cardNos[] = "'" . mysqli_real_escape_string($conn, $row['card_no']) . "'";    }	if (!empty($row['invoice_no'])) {        $apr_no_invoice_nos[] = "'" . mysqli_real_escape_string($conn, $row['invoice_no']) . "'";    }}/* $apr_noStr = implode(",", $apr_no_idNos);$apr_cardNos = implode(",", $apr_no_cardNos);$apr_invoice_no = implode(",", $apr_no_invoice_nos); */$apr_no_idNos = array_unique($apr_no_idNos);$apr_no_cardNos = array_unique($apr_no_cardNos);$apr_no_invoice_nos = array_unique($apr_no_invoice_nos);// Implode to comma-separated strings$apr_noStr = !empty($apr_no_idNos) ? implode(",", $apr_no_idNos) : '';$apr_cardNos = !empty($apr_no_cardNos) ? implode(",", $apr_no_cardNos) : '';$apr_invoice_no = !empty($apr_no_invoice_nos) ? implode(",", $apr_no_invoice_nos) : '';/* $u_query = "SELECT apx2.* FROM happi_bajaj_apx_transactions apx2 WHERE apx2.upload_date = '$bajaj_upload_date' AND NOT EXISTS ( SELECT 1 FROM happi_bajaj_do_transactions b JOIN happi_bajaj_ta_transactions ta ON b.app_cas_id = ta.txn_id WHERE b.do_id = apx2.apr_no AND ta.upload_date = '$bajaj_upload_date' AND ta.trans_date <= '$get_date' )";	 */$u_query = "SELECT * FROM happi_bajaj_apx_transactions WHERE upload_date = '$bajaj_upload_date' AND apr_no NOT IN ($apr_noStr) AND card_no NOT IN ($apr_cardNos)  AND invoice_no NOT IN ($apr_invoice_no) AND trn_date <= '$get_date'";	//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'Credit Card',    'Voucher No.',    'Card No.',    'Apr. No.',    'Invoice No.',    'Amount',    'Date');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    $seen_apr_no = [];  // track processed apr_no	while ($row = mysqli_fetch_assoc($u_res)) {		$apr_no = $row['apr_no'];		// check if already processed		if (isset($seen_apr_no[$apr_no])) {			continue;  // skip duplicate		}		// mark as seen		$seen_apr_no[$apr_no] = true;		$apx_amt = $row['apx_amt'];		$stdate1 = explode('-', $row['trn_date']);		$trn_date = $stdate1[2] . '-' . $stdate1[1] . '-' . $stdate1[0];		$lineData = array(			"BAJAJ FINANCE",			$row['voucher_no'],			"'" . $row['card_no'],			"'" . $row['apr_no'],			$row['invoice_no'],			$row['amount'],			$trn_date		);		$sheet->fromArray($lineData, NULL, 'A' . $rowIndex);		$rowIndex++;	}}// Output as Excel$filename = 'Apx-Bajaj-Not-Matched-BULK-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;