<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');/* $u_query = "SELECT a.*, b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode, b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status, b.rrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month, b.card_type_trns, c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amt    FROM happi_hdfc_transactions a     JOIN happi_all_transactions b ON(b.approval_code = a.approve_code AND b.acquirer = 'HDFC')     JOIN happi_apx_transactions c ON(c.apr_no = a.approve_code)     WHERE a.trans_date = '$get_date'    ORDER BY a.id ASC"; */		$u_query = "SELECT a.*, b.do_id, b.dis_val,b.make_item,b.serial_imei,b.asset_desc, c.voucher_no, c.apr_no, c.invoice_no AS apx_invoice_no, c.trn_date, c.amount AS apx_amt, d.dbd_amt, d.doc_value				FROM happi_bajaj_ta_transactions a 				JOIN happi_bajaj_do_transactions b ON(b.app_cas_id = a.txn_id) 				JOIN happi_bajaj_apx_transactions c ON(c.apr_no = b.do_id ) 				JOIN happi_dbd_master_data d ON(d.invoice_no = c.invoice_no) 				where a.trans_date = '$get_date'				ORDER BY a.id ASC"; //echo $u_query;exit;	//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'Branch Name',    'Customer Name',    'Asset Desc',    'Make',    'Serial IMEI No ',    'Txn Date',    'Txn ID',    'Deal ID',    'Invoice No',    'APX Aproval No',    'APX Invoice Date',    'Amount Fin',    'APX Amount',    'Disb Amount',    'DBD%',    'Bajaj DBD Charges',    'APX Amt - Disb Amt',	'APX Collected DBD',    'Difference DBD Charges');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    $seen_txn_ids = [];  // store already processed txn_ids	while ($row = mysqli_fetch_assoc($u_res)) {		$txn_id = $row['txn_id'];		// skip if this txn_id has already been processed		if (isset($seen_txn_ids[$txn_id])) {			continue;		}		// mark this txn_id as seen		$seen_txn_ids[$txn_id] = true;		$apx_amt   = $row['apx_amt'];		$disb_amt  = $row['disb_amt'];		if ($apx_amt == '') $apx_amt = 0;		$dbm_main = $apx_amt - $disb_amt;		$dbd_per = ($apx_amt != 0) ? (($dbm_main / $apx_amt) * 100) : '-';		$stdate = explode('-', $row['trans_date']);		$trans_date = $stdate[2] . '-' . $stdate[1] . '-' . $stdate[0];		$stdate1 = explode('-', $row['trn_date']);		$trn_date = $stdate1[2] . '-' . $stdate1[1] . '-' . $stdate1[0];		$dbd_amt = $row['dbd_amt'];		$Difference = $dbm_main - $dbd_amt;		if ($Difference == '') {			$Difference = '0';		}		$lineData = [			$row['branch_name'],			$row['customer_name'],			$row['asset_desc'],			$row['make_item'],			"'" . $row['serial_imei'],			$trans_date,			$row['txn_id'],			$row['do_id'],			$row['apx_invoice_no'],			$row['apr_no'],			$trn_date,			$row['amt_fn'],			$row['apx_amt'],			$row['disb_amt'],			is_numeric($dbd_per) ? round($dbd_per, 2) . '%' : $dbd_per,			$row['dis_val'],			$dbm_main,			$dbd_amt,			$Difference		];		$sheet->fromArray($lineData, NULL, 'A' . $rowIndex);		$rowIndex++;	}}// Output as Excel$filename = 'Bajaj-Matched-BULK-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;