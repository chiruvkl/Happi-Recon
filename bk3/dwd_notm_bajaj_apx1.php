<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$bajaj_ta_total_query = "SELECT upload_date FROM happi_bajaj_ta_transactions WHERE trans_date = '$get_date' GROUP BY upload_date"; $bajaj_ta_total_res = mysqli_query($conn, $bajaj_ta_total_query);$bajaj_ta_total_assoc = mysqli_fetch_assoc($bajaj_ta_total_res);$bajaj_upload_date = $bajaj_ta_total_assoc['upload_date'];$apx_total_query = "SELECT apr_no FROM happi_bajaj_apx_transactions where upload_date = '$bajaj_upload_date' group by apr_no";  $apx_total_res = mysqli_query($conn, $apx_total_query);$apx_total_cnt1 = mysqli_num_rows($apx_total_res); if($apx_total_cnt1 != 0){		$upload_apr_no = [];  // Array to hold trn_date values    while ($row = mysqli_fetch_assoc($apx_total_res)) {        $upload_apr_no[] = $row['apr_no'];    }    // Implode into a comma-separated string    $upload_apr_no_str = "'" . implode("','", $upload_apr_no) . "'";}/* 	$u_query = "SELECT a.* FROM happi_bajaj_apx_transactions aLEFT JOIN happi_bajaj_do_transactions c ON (c.do_id = a.apr_no)LEFT JOIN happi_bajaj_ta_transactions d ON (d.txn_id = c.app_cas_id  AND a.trn_date = d.trans_date)WHERE a.trn_date = '$get_date'  AND ( c.do_id IS NULL    OR d.txn_id IS NULL  )"; //echo $u_query;exit;	 */$u_query = "SELECT apx2.* FROM happi_bajaj_apx_transactions apx2 WHERE apx2.upload_date = '$bajaj_upload_date' AND NOT EXISTS ( SELECT 1 FROM happi_bajaj_do_transactions b JOIN happi_bajaj_ta_transactions ta ON b.app_cas_id = ta.txn_id WHERE b.do_id = apx2.apr_no AND ta.upload_date = '$bajaj_upload_date' AND ta.trans_date <= '$get_date' )";	//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'Credit Card',    'Voucher No.',    'Card No.',    'Apr. No.',    'Invoice No.',    'Amount',    'Date');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    while ($row = mysqli_fetch_assoc($u_res)) {        $apx_amt = $row['apx_amt'];		/*  $disb_amt = $row['disb_amt'];		 if($apx_amt == '')			 $apx_amt = 0;		 $dbm_main = $apx_amt - $disb_amt;		 $dbd_per = ($dbm_main / $apx_amt) * 100;		 if($apx_amt == 0){			 $dbd_per = '-';		 }		 		 $stdate = explode('-',$row['trans_date']); 		$trans_date = $stdate[2].'-'.$stdate[1].'-'.$stdate[0];		 */		$stdate1 = explode('-',$row['trn_date']); 		$trn_date = $stdate1[2].'-'.$stdate1[1].'-'.$stdate1[0];		 		//if($apx_amt != '') {			$lineData = array(				"BAJAJ FINANCE",				$row['voucher_no'],				"'".$row['card_no'],				"'".$row['apr_no'],				$row['invoice_no'],				$row['amount'],				$trn_date			);			$sheet->fromArray($lineData, NULL, 'A' . $rowIndex);			// Highlight red if Debuted MDR > 100		  /*  if ($debutedmdr > $actual_mdr) {				$sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([					'fill' => [						'fillType' => Fill::FILL_SOLID,						'startColor' => ['rgb' => 'FF9999']					]				]);			} */			$rowIndex++;		    }}// Output as Excel$filename = 'Apx-Bajaj-Not-Matched-BULK-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;