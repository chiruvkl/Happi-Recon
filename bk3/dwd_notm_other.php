<?phprequire 'vendor/autoload.php'; // path to PhpSpreadsheet autoloaduse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;include 'includes/database.php';$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');	$u_query = "SELECT 					a.*, 					b.voucher_no, 					b.apr_no, 					b.invoice_no, 					b.trn_date, 					b.amount AS apx_amt 				FROM 					happi_all_transactions a				LEFT JOIN 					happi_apx_transactions b ON a.transaction_id = b.apr_no				WHERE 					a.datetime = '$get_date'					AND a.acquirer NOT IN ('PHONEPE','HDFC','SBI87')					AND b.apr_no IS NULL				ORDER BY 					a.id ASC;";												//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$u_res_data = [];while ($u_res_res = mysqli_fetch_assoc($u_res)) {    $u_res_data[] = $u_res_res;}// Create spreadsheet$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Headers$fields = array(    'POS ID', 'TID', 'NAME AND LOC', 'Acquirer','TXN ID', 'RRN', 'Approval Code',    'Txn Amount', 'TXN Date', 'Apx Approval', 'Apx Invoice', 'Apx amt',    'Apx Date', 'Card Network', 'Card Colour');$sheet->fromArray($fields, NULL, 'A1');// Fill rows$rowIndex = 2;foreach ($u_res_data as $row) {   /*  $apx_amt = $row['apx_amt'];    $txn_amount = $row['net_amount'];    $diffamt = $apx_amt - $txn_amount;    if ($diffamt == '') $diffamt = 0;    $perc = ($apx_amt != 0) ? ($diffamt / $apx_amt) * 100 : 0;    $mdrper = '0.89';    if ($apx_amt > 2000) {        $TXN_Rate = 'ABOVE 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.89';    } else {        $TXN_Rate = 'BELOW 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.40';    }    $abc1 = round((($row['txn_amount'] - $row['net_amount']) / $row['txn_amount']) * 100 , 2);    $debutedmdr = $row['txn_amount'] - $row['net_amount'];    $abc2 = round(($debutedmdr / $row['txn_amount']) * 100 , 2);    $actual_mdr = round(($mdrper / 100) * $row['txn_amount'], 2); */	$datetime = $row['datetime'];		$datetime1 = explode('-',$row['datetime']);		$datetime = $datetime1[2].'-'.$datetime1[1].'-'.$datetime1[0];				$trn_date = $row['trn_date'];		$trn_date1 = explode('-',$row['trn_date']);		$trn_date = $trn_date1[2].'-'.$trn_date1[1].'-'.$trn_date1[0];    // Only populate lineData and write to sheet if apx_amt is not empty   // if($apx_amt != '') {        $lineData = array(            $row['pos'], $row['tid'], $row['store_name'], $row['acquirer'],             "'" .$row['transaction_id'], "'" . $row['rrn'], $row['approval_code'], $row['amount'],            $datetime, $row['apr_no'], $row['invoice_no'], $row['apx_amt'],            $trn_date, $row['card_network'], $row['card_colour']        );        $sheet->fromArray($lineData, NULL, 'A' . $rowIndex);        // Highlight red if MDR Charges > 100        /* if ($abc2 > $mdrper) {				$sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([					'fill' => [						'fillType' => Fill::FILL_SOLID,						'startColor' => ['rgb' => 'FF9999']					]				]);			} */        $rowIndex++;    //}}// Set filename$filename = 'OTHER-NOT-MATCHED-BULK-' . $get_date . '.xlsx';// Send headersheader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment; filename=\"$filename\"");header('Cache-Control: max-age=0');// Output Excel$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;?>