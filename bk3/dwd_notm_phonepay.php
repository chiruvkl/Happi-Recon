<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$u_query = "SELECT a.*, c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amt			FROM happi_all_transactions a			LEFT JOIN happi_apx_transactions c ON c.card_no = a.bill_invoice			WHERE a.datetime = '$get_date'  AND a.acquirer = 'PHONEPE'  AND c.card_no IS NULL ORDER BY a.id ASC";$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'POS NO', 'TID Number', 'Store Name', 'CARD TYPE', 'TRANS DATE', 'TXN Id', 'RRN No', 'APPROV CODE', 'Net amount', 'APX approval', 'Apx Invoice', 'Apx amt', 'Apx date');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    while ($row = mysqli_fetch_assoc($u_res)) {        $approval_code = $row['approval_code'];        $apx_amt = $row['apx_amt'];        $txn_amount = $row['net_amount'];        $diffamt = $apx_amt - $txn_amount;        $mdrper = '1.53';        if ($apx_amt > 2000) {            $TXN_Rate = 'ABOVE 2K';            $mdrper = ($row['card_type_trns'] == 'CREDIT') ? '1.53' : '1.06';        } else {            $TXN_Rate = 'BELOW 2K';            $mdrper = ($row['card_type_trns'] == 'CREDIT') ? '1.53' : '0.40';        }        $abc1 = round((($row['domestic_amt'] - $row['net_amount']) / $row['domestic_amt']) * 100, 2);        $debutedmdr = $row['domestic_amt'] - $row['net_amount'];        $abc2 = round(($debutedmdr / $row['domestic_amt']) * 100, 2);        $actual_mdr = round(($mdrper / 100) * $row['domestic_amt'], 2);				$datetime = $row['datetime'];		$datetime1 = explode('-',$row['datetime']);		$datetime = $datetime1[2].'-'.$datetime1[1].'-'.$datetime1[0];				$trn_date = $row['trn_date'];		$trn_date1 = explode('-',$row['trn_date']);		$trn_date = $trn_date1[2].'-'.$trn_date1[1].'-'.$trn_date1[0];        $lineData = array(            $row['pos'], $row['tid'], $row['store_name'], $row['payment_mode'], $datetime, "'".$row['transaction_id'], "'".$row['rrn'], $row['bill_invoice'], $row['amount'], $row['apr_no'], $row['invoice_no'], $row['apx_amt'], $trn_date        );        $sheet->fromArray($lineData, NULL, 'A' . $rowIndex);        // Highlight red if Debuted MDR > 100        if ($debutedmdr > 100) {            $sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([                'fill' => [                    'fillType' => Fill::FILL_SOLID,                    'startColor' => ['rgb' => 'FF9999']                ]            ]);        }        $rowIndex++;    }}// Output as Excel$filename = 'PHONEPAY-BULK-not-matched-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;