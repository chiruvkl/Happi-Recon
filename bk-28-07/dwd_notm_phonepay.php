<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$u_matched_query = "SELECT a.phonepe_referenceId				FROM happi_phonepe_transactions a 				JOIN happi_upi_transactions u ON(u.host_txn_id = a.phonepe_referenceId AND u.txn_date = a.transaction_date) 				JOIN happi_apx_transactions c ON(c.card_no = u.bill_reference_no AND c.trn_date = a.transaction_date) 				JOIN happi_all_transactions b ON(u.transaction_id = b.transaction_id AND a.transaction_date = b.datetime) 				where a.transaction_date = '$get_date' ORDER BY a.id ASC";$u_matched_res = mysqli_query($conn, $u_matched_query);$u_matched_count = mysqli_num_rows($u_matched_res);if($u_matched_count != 0){		$auth_code_no = [];  // Array to hold trn_date values   	while ($u_mathed_res_res = mysqli_fetch_assoc($u_matched_res)) {		$auth_code_no[] = $u_mathed_res_res['phonepe_referenceId'];	}    // Implode into a comma-separated string    $auth_code_no_str = "'" . implode("','", $auth_code_no) . "'";}$u_query = "SELECT a.*, u.pos_id,u.transaction_id, u.bill_reference_no,u.tid			FROM happi_phonepe_transactions a			LEFT JOIN happi_upi_transactions u ON(u.host_txn_id = a.phonepe_referenceId AND u.txn_date = a.transaction_date)			WHERE a.transaction_date = '$get_date'  AND a.phonepe_referenceId NOT IN ($auth_code_no_str) ORDER BY a.id ASC";//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'POS NO', 'TID Number', 'Store Name', 'Card Type', 'Trans Date', 'Settlement Date','Instrument', 'TXN Id', 'Bill Reference No', 'Bank Reference No', 'PhonePe Reference Id', 'Net Amount','Total Charges', 'APX Approval', 'Apx Invoice', 'Apx Amt', 'Apx Aate', 'APX TXN- TXN Diff amt');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    while ($row = mysqli_fetch_assoc($u_res)) {              		$transaction_date = $row['transaction_date'];		$datetime1 = explode('-',$row['transaction_date']);		$transaction_date = $datetime1[2].'-'.$datetime1[1].'-'.$datetime1[0];				$settlement_date = $row['settlement_date'];		$settlement_date1 = explode('-',$row['settlement_date']);		$settlement_date = $settlement_date1[2].'-'.$settlement_date1[1].'-'.$settlement_date1[0];						        $lineData = array(            $row['pos_id'], $row['tid'], $row['store_name'], $row['payment_type'], $transaction_date,$settlement_date, $row['instrument'],"'".$row['transaction_id'], "'".$row['bill_reference_no'],$row['bank_reference_no'], $row['phonepe_referenceId'],$row['ph_amount'],$row['fee'],  '--', '--', '--', '--', '0' );        $sheet->fromArray($lineData, NULL, 'A' . $rowIndex);        // Highlight red if Debuted MDR > 100        if ($debutedmdr > 100) {            $sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([                'fill' => [                    'fillType' => Fill::FILL_SOLID,                    'startColor' => ['rgb' => 'FF9999']                ]            ]);        }        $rowIndex++;    }}// Output as Excel$filename = 'PHONEPAY-NOT-MATCHED-BULK-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;