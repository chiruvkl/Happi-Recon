<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$all_data = [];$u_query_mathed = "SELECT a.*, b.do_id, b.dis_val,b.make_item,b.serial_imei,b.asset_desc, c.voucher_no, c.apr_no, c.invoice_no AS apx_invoice_no, c.trn_date, c.amount AS apx_amt, d.dbd_amt, d.doc_value				FROM happi_bajaj_ta_transactions a 				JOIN happi_bajaj_do_transactions b ON(b.app_cas_id = a.txn_id) 				JOIN happi_bajaj_apx_transactions c ON(c.apr_no = b.do_id AND c.upload_date = a.upload_date ) 				JOIN happi_dbd_master_data d ON(d.invoice_no = c.invoice_no) 				where a.trans_date = '$get_date' 				ORDER BY a.id ASC"; //echo $u_query;exit;	//echo $u_query;exit;$u_res_mathed = mysqli_query($conn, $u_query_mathed);$u_count_mathed = mysqli_num_rows($u_res_mathed);while ($row = mysqli_fetch_assoc($u_res_mathed)) {    $all_data[] = $row;}$txn_idNos = [];foreach ($all_data as $row) {    if (!empty($row['txn_id'])) {        $txn_idNos[] = "'" . mysqli_real_escape_string($conn, $row['txn_id']) . "'";    }}$txnNosStr = implode(",", $txn_idNos);$u_query = "SELECT a.*, b.do_id, b.dis_val,b.make_item,b.serial_imei,b.asset_desc, c.voucher_no, c.apr_no, c.invoice_no AS apx_invoice_no, c.trn_date, c.amount AS apx_amt, d.dbd_amt, d.doc_valueFROM    happi_bajaj_ta_transactions aLEFT JOIN    happi_bajaj_do_transactions b ON b.app_cas_id = a.txn_idLEFT JOIN    happi_bajaj_apx_transactions c ON (c.apr_no = b.do_id AND c.upload_date = a.upload_date)LEFT JOIN happi_dbd_master_data d ON(d.invoice_no = c.invoice_no)WHERE    a.trans_date = '$get_date' AND txn_id NOT IN ($txnNosStr)ORDER BY    a.id ASC";//echo $u_query;exit;	//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'Branch Name',    'Customer Name',    'Asset Desc',    'Make',    'Serial IMEI No ',    'Txn Date',    'Txn ID',    'Deal ID',    'Invoice No',    'APX Aproval No',    'APX Invoice Date',    'Amount Fin',    'APX Amount',    'Disb Amount',    'DBD%',    'Bajaj DBD Charges',    'APX Amt - Disb Amt',	'APX Collected DBD',    'Difference DBD Charges');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    while ($row = mysqli_fetch_assoc($u_res)) {         $apx_amt = $row['apx_amt'];		 $disb_amt = $row['disb_amt'];		 if($apx_amt == '')			 $apx_amt = 0;		 $dbm_main = $apx_amt - $disb_amt;		 $dbd_per = ($dbm_main / $apx_amt) * 100;		 if($apx_amt == 0){			 $dbd_per = '-';		 }		 		 $stdate = explode('-',$row['trans_date']); 		$trans_date = $stdate[2].'-'.$stdate[1].'-'.$stdate[0];				$stdate1 = explode('-',$row['trn_date']); 		$trn_date = $stdate1[2].'-'.$stdate1[1].'-'.$stdate1[0];		 $dbd_amt = $row['dbd_amt'];		$Difference = ($dbm_main - $dbd_amt);		 if($Difference == ''){			 $Difference = '0';		 }				//if($apx_amt != '') {			$lineData = array(				$row['branch_name'],				$row['customer_name'],				$row['asset_desc'],				$row['make_item'],				"'".$row['serial_imei'],				$trans_date,				$row['txn_id'],				$row['do_id'],				$row['apx_invoice_no'],				$row['apr_no'],				$trn_date,				$row['amt_fn'],				$row['apx_amt'],				$row['disb_amt'],				round($dbd_per,2,2) . '%',				$row['dis_val'],				$dbm_main,				$dbd_amt,				$Difference			);			$sheet->fromArray($lineData, NULL, 'A' . $rowIndex);			// Highlight red if Debuted MDR > 100		  /*  if ($debutedmdr > $actual_mdr) {				$sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([					'fill' => [						'fillType' => Fill::FILL_SOLID,						'startColor' => ['rgb' => 'FF9999']					]				]);			} */			$rowIndex++;		    }}// Output as Excel$filename = 'Bajaj-notMatched-BULK-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;