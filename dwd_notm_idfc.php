<?phperror_reporting(E_ALL ^ E_NOTICE ^ E_WARNING);include 'includes/database.php';require 'vendor/autoload.php'; // PhpSpreadsheet autoloaderuse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');$all_data = [];$u_query_mathed = "SELECT a.*, b.sfdc_id, b.application_id, b.applicant_name, b.city,b.invoice_no,b.asset_cost,b.loan_amount, b.dbd_inlclude_gst, b.net_disbursal_mount, b.neft_utr_no, b.actual_amount_paid,b.transaction_date, b.salespoint_name, c.voucher_no, c.apr_no, c.invoice_no AS apx_invoice_no, c.trn_date, c.amount AS apx_amt, d.dbd_amt, d.doc_value				FROM happi_idfc_kvb_transactions a 				JOIN happi_idfc_ta_transactions b ON(b.neft_utr_no = a.utr_no_dec) 				JOIN happi_idfc_apx_transactions c ON(c.apr_no = b.sfdc_id AND c.upload_date = a.upload_date) 				LEFT JOIN happi_dbd_master_data d ON(d.invoice_no = c.invoice_no) 				where a.value_date = '$get_date' 				ORDER BY a.id ASC"; //echo $u_query;exit;	//echo $u_query;exit;$u_res_mathed = mysqli_query($conn, $u_query_mathed);$u_count_mathed = mysqli_num_rows($u_res_mathed);while ($row = mysqli_fetch_assoc($u_res_mathed)) {    $all_data[] = $row;}$txn_idNos = [];foreach ($all_data as $row) {    if (!empty($row['utr_no_dec'])) {        $txn_idNos[] = "'" . mysqli_real_escape_string($conn, $row['utr_no_dec']) . "'";    }}$txnNosStr = implode(",", $txn_idNos);		$u_query = "SELECT a.*, b.sfdc_id, b.application_id, b.applicant_name, b.city, b.invoice_no,       b.asset_cost, b.loan_amount, b.dbd_inlclude_gst, b.net_disbursal_mount,       b.neft_utr_no, b.actual_amount_paid, b.transaction_date, b.salespoint_name,       c.voucher_no, c.apr_no, c.invoice_no AS apx_invoice_no, c.trn_date,       c.amount AS apx_amt, d.dbd_amt, d.doc_valueFROM happi_idfc_kvb_transactions aLEFT JOIN happi_idfc_ta_transactions b        ON b.neft_utr_no = a.utr_no_decLEFT JOIN happi_idfc_apx_transactions c        ON c.apr_no = b.sfdc_id  AND c.upload_date = a.upload_dateLEFT JOIN happi_dbd_master_data d        ON d.invoice_no = c.invoice_no WHERE a.value_date = '$get_date' AND a.utr_no_dec NOT IN ($txnNosStr)  ORDER BY a.id ASC";//echo $u_query;exit;	//echo $u_query;exit;$u_res = mysqli_query($conn, $u_query);$u_count = mysqli_num_rows($u_res);$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Set headers$headers = array(    'Branch Name',    'Customer Name',    'Value Date',    'UTR NO',    'Credit',    'SFDC ID',    'APX Invoice No',    'APX Approval No',    'APX Date',    'Asset Cost',    'APX TXN Amt',    'Net Disbursal Amount',    'IDFC DBD Charges',        'DBD%',    'Apx amt-Credit amt',	'Apx DBD Collected amt',    'Difference DBD Charges');$sheet->fromArray($headers, NULL, 'A1');$rowIndex = 2;if ($u_count > 0) {    while ($row = mysqli_fetch_assoc($u_res)) {        $apx_amt = $row['apx_amt'];		 $credit_amount = $row['credit_amount'];		 if($apx_amt == '')			 $apx_amt = 0;		 $dbm_main = $apx_amt - $credit_amount;		 $dbd_per = ($dbm_main / $apx_amt) * 100;		 if($apx_amt == 0){			 $dbd_per = '-';		 }		 		 $stdate = explode('-',$row['value_date']); 		$value_date = $stdate[2].'-'.$stdate[1].'-'.$stdate[0]; 		$stdate2 = explode('-',$row['trn_date']); 		$trn_date = $stdate2[2].'-'.$stdate2[1].'-'.$stdate2[0];		$dbd_amt = $row['dbd_amt'];		$Difference = ($dbm_main - $dbd_amt);		 if($Difference == ''){			 $Difference = '0';		 }		//if($apx_amt != '') {			$lineData = array(				$row['salespoint_name'],				$row['applicant_name'],				$value_date,				"'".$row['utr_no_dec'],				$row['credit_amount'],				"'".$row['sfdc_id'],				"'".$row['apx_invoice_no'],				$row['apr_no'],				$trn_date,				$row['asset_cost'],				$row['apx_amt'],				$row['net_disbursal_mount'],				$row['dbd_inlclude_gst'],				round($dbd_per, 2, 2) . '%',				$dbm_main,				$dbd_amt,				$Difference			);			$sheet->fromArray($lineData, NULL, 'A' . $rowIndex);			// Highlight red if Debuted MDR > 100		  /*  if ($debutedmdr > $actual_mdr) {				$sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([					'fill' => [						'fillType' => Fill::FILL_SOLID,						'startColor' => ['rgb' => 'FF9999']					]				]);			} */			$rowIndex++;		    }}// Output as Excel$filename = 'IDFC-Not-Matched-BULK-' . $get_date . '.xlsx';header('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment;filename=\"$filename\"");header('Cache-Control: max-age=0');$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;