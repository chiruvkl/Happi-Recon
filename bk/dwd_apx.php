<?phprequire 'vendor/autoload.php'; // path to PhpSpreadsheet autoloaduse PhpOffice\PhpSpreadsheet\Spreadsheet;use PhpOffice\PhpSpreadsheet\Writer\Xlsx;use PhpOffice\PhpSpreadsheet\Style\Fill;include 'includes/database.php';$get_date = (isset($_REQUEST['get_date']) && $_REQUEST['get_date'] != '') ? trim($_REQUEST['get_date']) : date('Y-m-d');	$all_data = [];  // final combined array// ---------- SBI query ----------$u_query_sbi = "SELECT      a.*,      b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode,      b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status,      b.rrn AS allrrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month,      b.card_type_trns,    c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amtFROM happi_sbi_transactions aJOIN (    SELECT * FROM happi_all_transactions    WHERE id IN (        SELECT MIN(id)        FROM happi_all_transactions        WHERE acquirer = 'SBI87'        GROUP BY approval_code    )) b ON b.approval_code = a.auth_codeJOIN (    SELECT * FROM happi_apx_transactions    WHERE id IN (        SELECT MIN(id)        FROM happi_apx_transactions        GROUP BY apr_no    )) c ON (c.apr_no = a.auth_code AND a.tran_date = c.trn_date)WHERE a.tran_date = '$get_date'ORDER BY a.id ASC";$u_res_sbi = mysqli_query($conn, $u_query_sbi);while ($row = mysqli_fetch_assoc($u_res_sbi)) {    $row['source'] = 'SBI';    $all_data[] = $row;}// ---------- HDFC query ----------$u_query_hdfc = "SELECT      a.*,      b.store_name, b.city, b.pos, b.acquirer, b.tid, b.payment_mode,      b.transaction_id, b.approval_code, b.amount, b.datetime, b.txn_status,      b.rrn, b.card_network, b.card_colour, b.emi_txn, b.emi_month, b.card_type_trns,      c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amtFROM happi_hdfc_transactions aJOIN (    SELECT * FROM happi_all_transactions    WHERE id IN (        SELECT MIN(id)        FROM happi_all_transactions        WHERE acquirer = 'HDFC'        GROUP BY approval_code    )) b ON b.approval_code = a.approve_codeJOIN (    SELECT * FROM happi_apx_transactions    WHERE id IN (        SELECT MIN(id)        FROM happi_apx_transactions        GROUP BY apr_no    )) c ON (c.apr_no = a.approve_code AND a.trans_date = c.trn_date)WHERE a.trans_date = '$get_date'ORDER BY a.id ASC";$u_res_hdfc = mysqli_query($conn, $u_query_hdfc);while ($row = mysqli_fetch_assoc($u_res_hdfc)) {    $row['source'] = 'HDFC';    $all_data[] = $row;}// ---------- PHONEPE query ----------$u_query_phonepe = "SELECT     a.*,     c.voucher_no, c.apr_no, c.invoice_no, c.trn_date, c.amount AS apx_amtFROM happi_all_transactions aJOIN happi_apx_transactions c     ON (c.card_no = a.bill_invoice AND a.datetime = c.trn_date)WHERE a.datetime = '$get_date' AND a.acquirer = 'PHONEPE' ORDER BY a.id ASC";$u_res_phonepe = mysqli_query($conn, $u_query_phonepe);while ($row = mysqli_fetch_assoc($u_res_phonepe)) {    $row['source'] = 'PHONEPE';    $all_data[] = $row;}// ---------- OTHER (not PHONEPE, HDFC, SBI) query ----------$u_query_other = "SELECT      a.*,      b.voucher_no, b.apr_no, b.invoice_no, b.trn_date, b.amount AS apx_amtFROM happi_all_transactions aJOIN happi_apx_transactions b     ON a.transaction_id = b.apr_noWHERE a.datetime = '$get_date' AND a.acquirer NOT IN ('PHONEPE','HDFC','SBI87')ORDER BY a.id ASC";$u_res_other = mysqli_query($conn, $u_query_other);while ($row = mysqli_fetch_assoc($u_res_other)) {    $row['source'] = 'OTHER';    $all_data[] = $row;}// ---------- Final result ----------$u_count = count($all_data);//echo "Total combined records: $u_count"; exit;// Create spreadsheet$spreadsheet = new Spreadsheet();$sheet = $spreadsheet->getActiveSheet();// Headers$fields = array(    'POS ID', 'TID', 'NAME AND LOC', 'Acquirer','TXN ID', 'RRN', 'Approval Code',    'Txn Amount', 'TXN Date', 'Apx Approval', 'Apx Invoice', 'Apx amt',    'Apx Date', 'Card Network', 'Card Colour');$sheet->fromArray($fields, NULL, 'A1');// Fill rows$rowIndex = 2;foreach ($all_data as $row) {   /*  $apx_amt = $row['apx_amt'];    $txn_amount = $row['net_amount'];    $diffamt = $apx_amt - $txn_amount;    if ($diffamt == '') $diffamt = 0;    $perc = ($apx_amt != 0) ? ($diffamt / $apx_amt) * 100 : 0;    $mdrper = '0.89';    if ($apx_amt > 2000) {        $TXN_Rate = 'ABOVE 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.89';    } else {        $TXN_Rate = 'BELOW 2K';        $mdrper = ($row['card_type'] == 'Credit') ? '0.89' : '0.40';    }    $abc1 = round((($row['txn_amount'] - $row['net_amount']) / $row['txn_amount']) * 100 , 2);    $debutedmdr = $row['txn_amount'] - $row['net_amount'];    $abc2 = round(($debutedmdr / $row['txn_amount']) * 100 , 2);    $actual_mdr = round(($mdrper / 100) * $row['txn_amount'], 2); */	$datetime = $row['datetime'];		$datetime1 = explode('-',$row['datetime']);		$datetime = $datetime1[2].'-'.$datetime1[1].'-'.$datetime1[0];				$trn_date = $row['trn_date'];		$trn_date1 = explode('-',$row['trn_date']);		$trn_date = $trn_date1[2].'-'.$trn_date1[1].'-'.$trn_date1[0];    // Only populate lineData and write to sheet if apx_amt is not empty   // if($apx_amt != '') {        $lineData = array(            $row['pos'], $row['tid'], $row['store_name'], $row['acquirer'],             "'" .$row['transaction_id'], "'" . $row['rrn'], $row['approval_code'], $row['amount'],            $datetime, $row['apr_no'], $row['invoice_no'], $row['apx_amt'],            $trn_date, $row['card_network'], $row['card_colour']        );        $sheet->fromArray($lineData, NULL, 'A' . $rowIndex);        // Highlight red if MDR Charges > 100        /* if ($abc2 > $mdrper) {				$sheet->getStyle("A{$rowIndex}:AB{$rowIndex}")->applyFromArray([					'fill' => [						'fillType' => Fill::FILL_SOLID,						'startColor' => ['rgb' => 'FF9999']					]				]);			} */        $rowIndex++;    //}}// Set filename$filename = 'APX-MATCHED-BULK-' . $get_date . '.xlsx';// Send headersheader('Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet');header("Content-Disposition: attachment; filename=\"$filename\"");header('Cache-Control: max-age=0');// Output Excel$writer = new Xlsx($spreadsheet);$writer->save('php://output');exit;?>